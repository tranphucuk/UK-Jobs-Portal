var newsletter={init:function(){this.loadData();this.registerEvents();this.loadCkEditor()},registerEvents:function(){var n=$("#frm-news").validate({errorClass:"red",rules:{txtNewsletterTitle:{required:!0,maxlength:500},txtNewsContent:"required"},messages:{txtNewsletterTitle:{required:"*Please enter title",maxlength:"*Max length of title is 50 character"},txtNewsContent:{required:"*Please enter content"}},showErrors:function(t,i){if(n.submitted){var r="";$.each(i,function(){r+="* "+this.message+"\n"});common.notify(r,"warn");submitted=!1}}});$("#ddlShowPage").on("change",function(){config.pageSize=$("#ddlShowPage :selected").text();config.pageIndex=1;$("#pagination-newsletter").twbsPagination("destroy");newsletter.loadData()});$("#txt-newsletter-keyword").on("keypress",function(n){n.which===13&&$("#btn-search-newsletter").click()});$("#btn-search-newsletter").off("click").on("click",function(){$("#pagination-newsletter").twbsPagination("destroy");$("#ddlShowPage").prop("selectedIndex",0);config.pageSize=10;config.pageIndex=1;newsletter.loadData()});$("#btn-create-newsletter").off("click").on("click",function(){$("#add-newsletter-modal").modal("show");newsletter.clearData()});$("#btn-save-news").off("click").on("click",function(){if(n.form()){var i=$("#hid-news-id").val(),t={};i!=undefined&&i!=""&&(t.Id=i,t.CreatedDate=$("#hid-news-date").val());t.Title=$("#txt-news-title").val();t.Content=CKEDITOR.instances["txt-news-content"].getData();t.Status=$("#ck-news-status").is(":checked")?1:0;$.ajax({type:"POST",url:"/Admin/NewsLetter/SaveNewsLetter",data:{newsLetterVm:t},beforeSend:common.runLoadingIndicator(),success:function(n){n==!0?(common.notify("Save newsletter success","success"),common.stopLoadingIndicator(),$("#add-newsletter-modal").modal("hide"),newsletter.loadData()):(common.notify("Save newsletter failed","error"),common.stopLoadingIndicator())}})}});$("body").on("click",".btnUpdateNewsletter",function(){var n=$(this).attr("data-id");$("#hid-news-id").val(n);$.ajax({type:"GET",url:"/Admin/Newsletter/GetDetail",data:{id:n},beforeSend:common.runLoadingIndicator(),success:function(n){$("#add-newsletter-modal").modal("show");$("#txt-news-title").val(n.Title);CKEDITOR.instances["txt-news-content"].setData(n.Content);$("#ck-news-status").prop("checked",n.Status);$("#hid-news-date").val(n.CreatedDate);common.stopLoadingIndicator()}})});$("body").on("click",".btnSendNewsletter",function(){var n=$(this).attr("data-id");common.confirm("<b>Are you sure to send this?<\/b><\/br><\/br>***This newsletter will be sent to all emails.",function(){$.ajax({type:"POST",url:"/Admin/Newsletter/SendNews",data:{newsId:n},beforeSend:common.runLoadingIndicator(),success:function(n){n==!0?(common.notify("Sent newsletter succeeded","success"),newsletter.loadData(),common.stopLoadingIndicator()):(common.notify("This newsletter is already sent to all emails.","warn"),common.stopLoadingIndicator())}})})})},loadData:function(){var n="",t=$("#tbl-newsletter-template").html();$.ajax({type:"GET",url:"/Admin/NewsLetter/GetAllPaging",data:{keyword:$("#txt-newsletter-keyword").val(),page:config.pageIndex,pageSize:config.pageSize},beforeSend:common.runLoadingIndicator(),success:function(i){$.each(i.Result,function(i,r){var u={};u.Id=r.Id;u.Title=r.Title;u.TotalReceiver=r.TotalReceiver;u.Status=common.getStatusLabel(r.Status);u.CreatedDate=common.formatDateTime(r.CreatedDate);n+=Mustache.render(t,u)});$("#tbl-newsletter-content").html(n);$("#lbl-total-newsletter").html(i.RowCount);i.RowCount>0&&newsletter.pagination(i.RowCount);common.stopLoadingIndicator()}})},loadCkEditor:function(){CKEDITOR.replace("txtNewsContent",{language:"en",width:"715px",height:"310px"});$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(n){this.$element[0]===n.target||this.$element.has(n.target).length||$(n.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")},this))}},clearData:function(){$("#hid-news-id").val("");$("#txt-news-title").val("");CKEDITOR.instances["txt-news-content"].setData("");$("#hid-news-date").val("")},pagination:function(n){var t=Math.ceil(n/config.pageSize);$("#pagination-newsletter").twbsPagination({totalPages:t,visiblePages:5,onPageClick:function(n,t){t!=config.pageIndex&&(config.pageIndex=t,newsletter.loadData())}})}};newsletter.init();